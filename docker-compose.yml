services:
  # =============================================================================
  # TRAEFIK - Reverse Proxy for woodcreek.ai
  # =============================================================================
  
  traefik:
    image: traefik:v3.2
    container_name: woodcreek-traefik
    restart: unless-stopped
    environment:
      - CLOUDFLARE_EMAIL=${CLOUDFLARE_EMAIL}
      - CLOUDFLARE_DNS_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}
    ports:
      - "8880:80"
      - "8443:443"
      - "8881:8080"  # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./infra/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./infra/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ./infra/traefik/acme.json:/acme.json
    networks:
      - woodcreek_net

  # =============================================================================
  # CLOUDFLARED - Tunnel to Cloudflare
  # =============================================================================

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: woodcreek-cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - traefik
    networks:
      - woodcreek_net

  # =============================================================================
  # WOODCREEK AGENTS API
  # =============================================================================
  
  agents-api:
    build:
      context: ./dacribagents-api
      dockerfile: Dockerfile
    container_name: woodcreek-agents-api
    restart: unless-stopped
    volumes:
      - sqlite_data:/app/data
    environment:
      LLM_PROVIDER: local
      VLLM_BASE_URL: http://100.71.224.45:8000/v1
      VLLM_MODEL_NAME: gpt-oss-20b
      MILVUS_HOST: 100.103.47.127 # woodcreek-milvus
      MILVUS_PORT: 19530
      POSTGRES_HOST: woodcreek-postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: woodcreek
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: woodcreek_agents
      ENVIRONMENT: production
      LOG_LEVEL: INFO
      TELNYX_API_KEY: ${TELNYX_API_KEY}
      SMS_INGEST_SECRET: ${SMS_INGEST_SECRET}      
      LATTICE_DATABASE_URL: ${LATTICE_DATABASE_URL}
    depends_on:
      milvus:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - woodcreek_net

  # =============================================================================
  # MILVUS - GPU-Accelerated Vector Database
  # =============================================================================
  
  etcd:
    image: quay.io/coreos/etcd:v3.5.16
    container_name: woodcreek-etcd
    restart: unless-stopped
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - etcd_data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - woodcreek_net

  minio:
    image: minio/minio:RELEASE.2024-11-07T00-52-20Z
    container_name: woodcreek-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    command: minio server /data --console-address ":9001"
    ports:
      - "9102:9000"
      - "9101:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - woodcreek_net

  milvus:
    image: milvusdb/milvus:v2.5.2-gpu
    container_name: woodcreek-milvus
    restart: unless-stopped
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      ETCD_ENDPOINTS: woodcreek-etcd:2379
      MINIO_ADDRESS: woodcreek-minio:9000
      MINIO_ACCESS_KEY_ID: ${MINIO_ROOT_USER}
      MINIO_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD}
      MINIO_USE_SSL: "false"
      MINIO_BUCKET_NAME: woodcreek-milvus
      KNOWHERE_GPU_MEM_POOL_SIZE: "4096"
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "19531:19530"
      - "9191:9091"
    command: ["milvus", "run", "standalone"]
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    networks:
      - woodcreek_net

  # =============================================================================
  # POSTGRESQL - LangGraph Checkpoints & App State
  # =============================================================================
  
  postgres:
    image: postgres:16-alpine
    container_name: woodcreek-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: woodcreek
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: woodcreek_agents
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U woodcreek -d woodcreek_agents"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - woodcreek_net
  # =============================================================================
  # EMAIL WORKER - Multi-Mailbox Email Ingestion Service
  # =============================================================================
  email-worker:
    build:
      context: ./dacribagents-api
      dockerfile: Dockerfile
    container_name: woodcreek-email-worker
    restart: unless-stopped
    command: python -m dacribagents.cli.email_worker_lattice
    environment:
      # Kafka (Confluent Cloud) - for publishing to Lattice
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_SASL_USERNAME: ${KAFKA_SASL_USERNAME}
      KAFKA_SASL_PASSWORD: ${KAFKA_SASL_PASSWORD}
      KAFKA_TOPIC_RAW: lattice.mail.raw.v1
      
      # Lattice tenant
      LATTICE_TENANT_ID: woodcreek
      
      # Polling configuration
      EMAIL_POLL_MINUTES: ${EMAIL_POLL_MINUTES:-5}
      
      # Mailbox list
      WORKMAIL_MAILBOXES: agents,solar,hoa
      
      # Agents mailbox
      WORKMAIL_AGENTS_EMAIL: ${WORKMAIL_AGENTS_EMAIL}
      WORKMAIL_AGENTS_PASSWORD: ${WORKMAIL_AGENTS_PASSWORD}
      WORKMAIL_AGENTS_EMAIL_ALIAS: agents@woodcreek.me
      WORKMAIL_AGENTS_ACCOUNT_ID: workmail-agents
      WORKMAIL_AGENTS_FOLDER: INBOX
      WORKMAIL_AGENTS_TARGET_FOLDER: agents
      
      # Solar mailbox
      WORKMAIL_SOLAR_EMAIL: ${WORKMAIL_SOLAR_EMAIL}
      WORKMAIL_SOLAR_PASSWORD: ${WORKMAIL_SOLAR_PASSWORD}
      WORKMAIL_SOLAR_EMAIL_ALIAS: solar@woodcreek.me
      WORKMAIL_SOLAR_ACCOUNT_ID: workmail-solar
      WORKMAIL_SOLAR_FOLDER: INBOX
      WORKMAIL_SOLAR_TARGET_FOLDER: solar
      
      # HOA mailbox
      WORKMAIL_HOA_EMAIL: ${WORKMAIL_HOA_EMAIL}
      WORKMAIL_HOA_PASSWORD: ${WORKMAIL_HOA_PASSWORD}
      WORKMAIL_HOA_EMAIL_ALIAS: hoa@woodcreek.me
      WORKMAIL_HOA_ACCOUNT_ID: workmail-hoa
      WORKMAIL_HOA_FOLDER: INBOX
      WORKMAIL_HOA_TARGET_FOLDER: hoa
      
      MINIO_ENDPOINT: ${LATTICE_MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${LATTICE_MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${LATTICE_MINIO_ROOT_PASSWORD}
      MINIO_BUCKET: ${LATTICE_MINIO_BUCKET}

      # Logging
      LOG_LEVEL: INFO
    healthcheck:
      test: ["CMD", "pgrep", "-f", "email_worker_lattice"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - woodcreek_net
    # No depends_on needed - we're publishing to external Kafka, not local services

  # ---------------------------------------------------------------------------
  # Backfill Job (run manually, not continuously)
  # ---------------------------------------------------------------------------
  email-backfill:
    build:
      context: ./dacribagents-api
      dockerfile: Dockerfile
    container_name: woodcreek-email-backfill
    profiles: ["backfill"]  # Only run when explicitly requested
    command: >
      python -m dacribagents.cli.email_worker_lattice_backfill
      --mailbox ${BACKFILL_MAILBOX:-agents}
      --folder ${BACKFILL_FOLDER:-INBOX}
      --limit ${BACKFILL_LIMIT:-100}
    environment:
      # Same Kafka config as worker
      KAFKA_BROKERS: ${KAFKA_BROKERS}
      KAFKA_SASL_USERNAME: ${KAFKA_SASL_USERNAME}
      KAFKA_SASL_PASSWORD: ${KAFKA_SASL_PASSWORD}
      KAFKA_TOPIC_RAW: lattice.mail.raw.v1
      LATTICE_TENANT_ID: woodcreek
      
      # Mailbox configs (same as worker)
      WORKMAIL_MAILBOXES: agents,solar,hoa
      WORKMAIL_AGENTS_EMAIL: ${WORKMAIL_AGENTS_EMAIL}
      WORKMAIL_AGENTS_PASSWORD: ${WORKMAIL_AGENTS_PASSWORD}
      WORKMAIL_AGENTS_EMAIL_ALIAS: agents@woodcreek.me
      WORKMAIL_AGENTS_ACCOUNT_ID: workmail-agents
      WORKMAIL_SOLAR_EMAIL: ${WORKMAIL_SOLAR_EMAIL}
      WORKMAIL_SOLAR_PASSWORD: ${WORKMAIL_SOLAR_PASSWORD}
      WORKMAIL_SOLAR_EMAIL_ALIAS: solar@woodcreek.me
      WORKMAIL_SOLAR_ACCOUNT_ID: workmail-solar
      WORKMAIL_HOA_EMAIL: ${WORKMAIL_HOA_EMAIL}
      WORKMAIL_HOA_PASSWORD: ${WORKMAIL_HOA_PASSWORD}
      WORKMAIL_HOA_EMAIL_ALIAS: hoa@woodcreek.me
      WORKMAIL_HOA_ACCOUNT_ID: workmail-hoa
    networks:
      - woodcreek_net

volumes:
  traefik_certs:
  etcd_data:
  minio_data:
  milvus_data:
  postgres_data:
  sqlite_data:

networks:
  woodcreek_net:
    name: woodcreek_net
    driver: bridge
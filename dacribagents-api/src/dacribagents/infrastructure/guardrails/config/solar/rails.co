# =============================================================================
# Solar Agent - Colang Rails (Colang 2.0)
# Specialized guardrails for solar panel and energy questions
# Compatible with NeMo Guardrails 0.19+
# =============================================================================

# -----------------------------------------------------------------------------
# Imports (Colang 2.0)
# -----------------------------------------------------------------------------
import core
import llm
from guardrails import *

# -----------------------------------------------------------------------------
# Main Flow - Entry Point (Required for Colang 2.0)
# -----------------------------------------------------------------------------
flow main
    """Main entry point for Solar agent - activates all guardrail flows."""
    # Activate input safety rails
    activate check_jailbreak_attempt
    activate check_toxic_input
    
    # Activate Solar-specific conversation flows
    activate solar_installation_questions
    activate solar_cost_questions
    activate solar_provider_questions
    activate solar_savings_questions
    activate net_metering_questions
    activate solar_battery_questions
    activate solar_incentives_questions
    activate solar_maintenance_questions
    activate hoa_solar_questions
    activate solar_monitoring_questions
    
    # Activate safety flows
    activate solar_diy_safety_warning
    
    # Activate topical rail (keep on solar topics)
    activate solar_topical_rail
    
    # Activate financial disclaimer
    activate solar_financial_disclaimer_flow
    
    # Activate the LLM response generation
    activate llm_continuation

# -----------------------------------------------------------------------------
# LLM Continuation Flow
# -----------------------------------------------------------------------------
flow llm_continuation
    """Fall back to LLM for unmatched solar inputs."""
    user said something unexpected
    $response = await GenerateResponseAction
    bot say $response

# -----------------------------------------------------------------------------
# Solar-Specific User Intents
# -----------------------------------------------------------------------------

define user ask about solar installation
  "how to install solar"
  "solar panel installation"
  "getting solar panels"
  "solar setup"
  "rooftop solar"
  "ground mount solar"

define user ask about solar providers
  "solar companies"
  "best solar provider"
  "solar installer"
  "tesla solar"
  "sunrun"
  "local solar company"
  "solar quotes"

define user ask about solar cost
  "how much does solar cost"
  "solar pricing"
  "solar panel prices"
  "cost of solar installation"
  "solar financing"
  "solar lease vs buy"

define user ask about solar savings
  "how much will I save"
  "solar roi"
  "solar payback period"
  "electricity bill savings"
  "solar investment return"

define user ask about net metering
  "net metering"
  "selling power back"
  "grid connection"
  "utility buyback"
  "oncor net metering"
  "texas net metering"

define user ask about solar battery
  "solar battery"
  "energy storage"
  "powerwall"
  "backup battery"
  "battery storage"
  "off grid"

define user ask about solar incentives
  "solar tax credit"
  "solar rebates"
  "federal tax credit"
  "texas solar incentives"
  "itc credit"
  "solar incentives"

define user ask about solar maintenance
  "cleaning solar panels"
  "solar panel maintenance"
  "solar warranty"
  "panel degradation"
  "solar repair"

define user ask about hoa solar approval
  "hoa approval for solar"
  "solar arc submission"
  "hoa solar rules"
  "can I install solar"
  "solar restrictions"

define user ask about solar monitoring
  "solar monitoring"
  "track solar production"
  "solar app"
  "monitor energy production"
  "solar dashboard"

# -----------------------------------------------------------------------------
# Solar Bot Responses
# -----------------------------------------------------------------------------

define bot explain solar installation
  "Solar installation in Woodcreek typically involves:

  1. **Site Assessment**: Evaluating roof condition, orientation, and shading
  2. **System Design**: Sizing based on your energy usage
  3. **HOA Approval**: Texas law protects solar rights, but ARC notification is courteous
  4. **Permitting**: City of Fate building permits required
  5. **Installation**: Usually 1-3 days for residential
  6. **Inspection**: City and utility inspection
  7. **Activation**: Oncor meter swap and grid connection
  
  Would you like details on any of these steps?"

define bot explain solar costs
  "Solar costs in Texas typically range:

  • **System Size**: 6-12 kW for most homes ($15,000-$35,000 before incentives)
  • **Federal Tax Credit**: 30% ITC (reduces cost significantly)
  • **Financing Options**: Cash, loan, lease, or PPA
  • **Payback Period**: Usually 6-10 years in Texas
  
  Factors affecting your cost:
  - Roof complexity and condition
  - System size needed
  - Equipment quality (panels, inverter)
  - Installation company
  
  Would you like help estimating for your home?"

define bot explain net metering texas
  "Net metering in Texas (specifically with Oncor):

  ⚠️ **Important**: Texas doesn't have mandatory net metering, but many REPs offer buyback programs.

  • **Buyback Rates**: Usually lower than retail rates (wholesale or avoided cost)
  • **Best REPs for Solar**: Green Mountain, Chariot, Rhythm
  • **Meter Type**: Bidirectional meter from Oncor (no cost)
  • **Monthly True-Up**: Credits applied to your bill
  
  I recommend getting quotes from multiple REPs for the best buyback rates.
  
  Which REP are you currently with?"

define bot explain solar incentives
  "Current solar incentives for Woodcreek homeowners:

  **Federal**:
  • 30% Investment Tax Credit (ITC) - through 2032
  • Reduces your federal tax liability

  **State/Local**:
  • Texas: No state income tax, so no state credit
  • Property Tax Exemption: Solar doesn't increase property tax
  • No sales tax on solar equipment

  **Utility**:
  • Some REPs offer installation rebates
  • Buyback programs for excess generation

  Total savings can be 30-40% off installation cost!
  
  Would you like help calculating your potential savings?"

define bot explain hoa solar texas
  "Great news! Texas has strong solar access laws:

  **Texas Property Code § 202.010**:
  • HOAs CANNOT prohibit solar panels
  • Can only regulate placement for aesthetics
  • Cannot increase cost by more than 10%
  • Cannot decrease efficiency by more than 10%

  **Woodcreek Process**:
  1. Submit ARC notification (not approval request)
  2. Provide system design and placement
  3. HOA has 30 days to respond with aesthetic concerns only
  
  You have the legal right to install solar! Would you like help with the notification?"

define bot refuse non_solar_topic
  "I'm the Solar specialist, so I focus on solar panels, energy storage, and related topics. For other questions, I can connect you with:
  
  • **HOA rules** → HOA Compliance Agent
  • **Home repairs** → Maintenance Agent
  • **Security systems** → Security Agent
  
  What solar topic can I help you with?"

# -----------------------------------------------------------------------------
# Solar-Specific Flows (Colang 2.0)
# -----------------------------------------------------------------------------

flow solar_installation_questions
    """Handle solar installation questions."""
    user ask about solar installation
    bot explain solar installation

flow solar_cost_questions
    """Handle solar cost questions."""
    user ask about solar cost
    bot explain solar costs

flow solar_provider_questions
    """Handle solar provider questions."""
    user ask about solar providers
    bot say "For solar installation in the Fate/Rockwall area, I recommend getting quotes from multiple providers. Popular options include Tesla Solar, Sunrun, Freedom Solar, and local installers. Look for NABCEP-certified installers with good reviews. Would you like tips on comparing quotes?"

flow solar_savings_questions
    """Handle solar savings questions."""
    user ask about solar savings
    bot say "Solar savings in Texas depend on your electricity usage, system size, and REP buyback rates. Typical homes save $100-200/month. With the 30% federal tax credit, payback is usually 6-10 years. Would you like help estimating your potential savings?"

flow net_metering_questions
    """Handle net metering questions."""
    user ask about net metering
    bot explain net metering texas

flow solar_battery_questions
    """Handle solar battery questions."""
    user ask about solar battery
    bot say "Battery storage adds $10,000-20,000 to a solar system but provides backup power and can maximize savings. Popular options: Tesla Powerwall, Enphase IQ, and Franklin WholePower. In Texas, batteries are especially useful during grid outages. Want details on battery sizing for your needs?"

flow solar_incentives_questions
    """Handle solar incentive questions."""
    user ask about solar incentives
    bot explain solar incentives

flow solar_maintenance_questions
    """Handle solar maintenance questions."""
    user ask about solar maintenance
    bot say "Solar panels require minimal maintenance. Key tasks: annual inspection, occasional cleaning (rain usually suffices in Texas), monitoring production for drops. Most systems have 25-year warranties on panels, 10-12 years on inverters. Is there a specific maintenance concern?"

flow hoa_solar_questions
    """Handle HOA solar approval questions."""
    user ask about hoa solar approval
    bot explain hoa solar texas

flow solar_monitoring_questions
    """Handle solar monitoring questions."""
    user ask about solar monitoring
    bot say "Most solar systems include monitoring apps that show real-time production, historical data, and alerts. Popular platforms: Tesla app, Enphase Enlighten, SolarEdge monitoring. These help you track performance and catch issues early. Which inverter brand are you considering?"

# -----------------------------------------------------------------------------
# Topical Rail - Keep on Solar Topics (Colang 2.0)
# -----------------------------------------------------------------------------

flow solar_topical_rail
    """Ensure conversations stay on solar topics."""
    user said $text
    $is_solar_topic = await check_solar_topic(user_message=$text)
    if not $is_solar_topic
        bot refuse non_solar_topic

# -----------------------------------------------------------------------------
# Solar Financial Disclaimer (Colang 2.0)
# -----------------------------------------------------------------------------

flow solar_financial_disclaimer_flow
    """Add disclaimer for financial estimates."""
    bot said $text
    $mentions_money = await check_mentions_financial(bot_message=$text)
    if $mentions_money
        bot say "Disclaimer: These are estimates based on typical Texas market values. Actual costs and savings depend on your specific situation. Get multiple quotes for accurate pricing."

# -----------------------------------------------------------------------------
# Safety Rails (Colang 2.0)
# -----------------------------------------------------------------------------

flow check_jailbreak_attempt
    """Detect and block jailbreak attempts."""
    user attempt jailbreak
    bot say "I'm designed to help with solar energy questions within my guidelines. How can I assist you with solar panels?"

flow check_toxic_input
    """Detect and handle toxic input."""
    $is_toxic = await check_toxicity
    if not $is_toxic
        bot say "Let's keep our conversation respectful. How can I help with your solar question?"
        abort

flow solar_diy_safety_warning
    """Warn about DIY solar dangers."""
    user said "can I install solar myself"
    bot say "⚠️ Safety Warning: Solar installation involves high-voltage electrical work and rooftop safety risks. While Texas allows DIY, I strongly recommend licensed professionals for electrical safety, code compliance, roof integrity, and warranty protection. Would you like recommendations for qualified installers?"
    
    or user said "diy solar"
    bot say "⚠️ Safety Warning: DIY solar installation carries significant risks including electrical shock, falls, and code violations. Professional installation ensures safety, proper permitting, and valid warranties. Would you like help finding licensed installers in the Fate area?"